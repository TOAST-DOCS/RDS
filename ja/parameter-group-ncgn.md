## Database > RDS for MySQL > パラメータグループ

## パラメータグループ

RDS for MySQLはDBインスタンスにインストールされたMySQLの設定を適用するためにパラメータグループ機能を提供します。パラメータグループはMySQLを設定できるパラメータの集合です。サービス起動時、すべてのDBエンジンのバージョン別に基本パラメータグループを提供します。基本パラメータグループは`default.{DBエンジンバージョン名}`で提供され、バージョン別に推奨する基本パラメータ値で構成されています。基本パラメータグループは一般パラメータグループと同じように修正したり、削除することができます。

### パラメータグループの作成

必要に応じてパラメータコンソールでパラメータグループを作成できます。パラメータグループはDBエンジンバージョンごとに作成し、名前を付与することができ、下記のような制約事項があります。

* パラメータグループ名はリージョンごとに一意でなければなりません。
* パラメータグループの名前は1～100の間の英字、数字、一部の記号(-, _, .)だけを使用することができ、最初の文字は英字のみ使用できます。

パラメータグループの作成時、パラメータは常にデフォルト値で作成されます。既存のパラメータグループを基準に作成するには、パラメータコピー機能を利用してパラメータグループを作成する必要があります。

### パラメータグループのコピー

既存のパラメータグループを基準に新規パラメータグループを作成します。コピーした新規パラメータグループは、元のパラメータグループのパラメータ値で構成されます。元のパラメータグループとコピーしたパラメータグループの間には、いかなる関係もなく、元のパラメータグループの変更や削除は、コピーしたパラメータグループにいかなる影響も与えません。

### パラメータグループのリセット

パラメータグループをリセットすると、すべてのパラメータの値をDBエンジンバージョンのデフォルト値に変更します。

<a id="apply"></a>
### パラメータグループの適用

DBインスタンスの作成または修正時、DBインスタンスに適用するパラメータグループを選択できます。1つのDBインスタンスに1つのパラメータグループが適用され、1つのパラメータグループは複数のDBインスタンスに適用できます。パラメータグループのパラメータが変更されると、その変更はすぐにDBインスタンスに適用されません。接続されたDBインスタンスが存在する場合、パラメータグループは`適用必要`状態に変更されます。DBインスタンスリスト画面でパラメータグループと接続されたDBインスタンスを選択した後、**パラメータグループの変更内容を適用**をクリックしてパラメータの変更をDBインスタンスに反映できます。接続されたすべてのDBインスタンスにパラメータグループの変更が適用されると、パラメータグループは`適用完了`状態に変更されます。

> [注意]
> 再起動が必要なパラメータが変更された場合、適用過程でDBインスタンスが再起動されます。

### パラメータグループの比較

コンソールで異なる2つのパラメータグループを選択した後、**比較**をクリックすると、パラメータが何が違うかを確認できます。同じDBエンジンだけでなく、異なるDBエンジンバージョンのパラメータグループも比較できます。

### パラメータグループの削除

DBインスタンスに適用しているパラメータグループ以外は、自由に削除できます。DBインスタンスに適用しているパラメータグループを削除するには、削除する前に接続されたすべてのDBインスタンスのパラメータグループを先に変更する必要があります。

## パラメータ

パラメータは下記のような情報を含んでいます。

| 項目     | 説明                                                                                                                              |
|--------|---------------------------------------------------------------------------------------------------------------------------------|
| グループ   | オプションファイル(my.cnf)のオプショングループです。                                                                                                  |
| 名前     | オプションファイル(my.cnf)のオプション名です。<br/>オプション名とシステム変数(System Variables)が異なる場合、(**_- Variable_**: `システム変数(System Variables)`)形式で追加表示します。 |
| 値      | パラメータに適用する値です。                                                                                                                  |
| 許可された値 | パラメータに適用できる値の範囲です。<br/>                                                                                                         |
| 適用タイプ  | `固定`と`動的`に区分されます。<br/>`固定`の場合、パラメータ変更事項を適用するにはDBインスタンスを再起動する必要があります。<br/>`動的`の場合、DBインスタンスを再起動しなくてもパラメータが適用されます。                 |
| データ形式  | パラメータ値の形式を示します。                                                                                                                 | 
| 数式の使用  | 数式を使用するかどうかを示します。                                                                                                               |

### パラメータ変数、数式および関数

特定のパラメータは固定された値を使うより、DBインスタンスと関連付けられた値を利用した式で表現する方が良い場合があります。これをサポートするために、`NUMERIC`、`INTEGER`データ形式については、あらかじめ定義された変数、式、関数を使用できます。

* 数式
    * `()`, `+`, `-`, `*`, `/`を使用できます。
    * 数式の結果は常に数字でなければなりません。
    * データ形式が`INTEGER`の場合、小数点以下は切り捨てます。
    * データ形式が`NUMERIC`の場合、小数点以下を四捨五入します。
* 関数
    * `max(a, b, ...)`:複数の値の中から最も大きい値を返します。
    * `min(a, b, ...)`:複数の値の中から最も小さい値を返します。
    * `sum([a, b, ...])`:複数の値の合計を返します。
* 変数
    * `ramSizeByte`:現在DBインスタンスタイプのメモリサイズのバイト値を表します。
    * `vCPU`:現在DBインスタンスタイプの仮想CPUコア数を表します。
    * `dbPort`:現在DBインスタンスのDBポートを表します。
    * `serverId`:現在DBインスタンスに付与したサーバーIDを表します。
    * `readOnly`:現在DBインスタンスが読み取り専用の場合`1`、または`0`を表します。

以下の例は`innodb_buffer_pool_size`パラメータのデフォルト値で、DBインスタンスタイプのメモリサイズの6/10サイズに設定することを表します。

```
ramSizeByte * 6 / 10
```

### パラメータの変更

コンソールでパラメータグループを選択した後、**パラメータ編集**をクリックしてパラメータを変更できます。変更できないパラメータは、値が一般テキストで表示され、変更できるパラメータは、値を変更できるINPUTが表示されます。編集画面で**変更内容のプレビュー**をクリックすると、変更されたパラメータを確認できる別のポップアップ画面が表示され、**リセット**を押すと、変更する前に戻すことができます。編集モードで変更したすべての値は、**変更を保存**をクリックするとパラメータグループに反映されます。変更されたパラメータグループのDBインスタンスへの反映は[パラメータグループ適用](parameter-group/#apply)項目を参照してください。

## GTID 제약조건

GTID모드에서는 enforce_gtid_consistency=ON 으로 할때 다음 제약들이 적용됩니다. 참고 : [https://dev.mysql.com/doc/refman/8.4/en/replication-gtids-restrictions.html](https://dev.mysql.com/doc/refman/8.4/en/replication-gtids-restrictions.html)

### ENFORCE_GTID_CONSISTENCY

* OFF : 제약대상 쿼리 허용
* WARN : 제약대상 쿼리를 허용하지만 warning 발생
* ON : 제약대상 쿼리 허용안함

### 고객 영향도

> GTID를 이용한 복제의 아래 제한 사항에 해당 하는 쿼리를 사용 할 수 없게 됩니다 (에러가 발생합니다)

1. 비 트랜잭션 저장 엔진과 관련된 업데이트
    * MyISAM과 같은 비 트랜잭션 저장 엔진과 관련된 업데이트를 INNODB 와 같이 트랜젝션을 지원하는 저장엔진을 사용하는 업데이트와 한 트랜젝션에서 수행할 수 없습니다.
    * 소스와 복제본이 동일한 테이블이 다른 스토리지 엔진을 사용하는 경우에도 문제가 발생합니다.
    * 비 트랜잭션 테이블에서 작동하도록 정의된 트리거가 동일 유형의 문제를 일으킬 수 있습니다.
2. CREATE TABLE ... SELECT 구문(8.0.21 이전 버전의 경우)
3. binlog_format이 STATEMENT 일때, 트랜잭션/프로시저/함수/트리거 내부에서 임시테이블을 생성/삭제 할 수 없습니다.

### 고객 권장 사전 조치

1. 가능하면 MyISAM과 같은 비트랜잭션 저장 엔진을 사용하지 마세요. 사용한다면 INNODB 같은 트랜젝션 저장엔진과 한 트랜젝션에서 업데이트를 수행하지 마세요.
2. CREATE TABLE ... SELECT 구문(8.0.21 이전 버전의 경우)을 사용하지 마세요.
    ```
    예시)  
    create table tbl_backup as select * from tbl_ori; 
    를 다음과 같이 변형해야 합니다.
    create table tbl_backup like tbl_ori; insert tbl_backup select * from tbl_ori;
    ```

## GTID 적용단계

### gtid_mode

| 값 | Source 에서 동작 | Replica에서 동작 |
| :--- | :----------- | :----------- |
| OFF | GTID 미적용 | GTID 처리 불가 |
| OFF_PERMISSIVE | GTID 도 처리 가능 | GTID 도 처리 가능 |
| ON_PERMISSIVE | GTID 적용 | GTID 적용 |
| ON | GTID만 처리 | GTID만 처리 |

### RDS에서 GTID 적용 절차

GTID를 원활하게 적용하기 위해서, gtid_mode (gtid의 적용단계) 와 enforce_gtid_consistency(쿼리적용 제한단계) 를 파라미터 그룹을 통해 다음 순서로 적용해야 합니다.
참고 : [https://dev.mysql.com/doc/refman/8.4/en/replication-mode-change-online-enable-gtids.html](https://dev.mysql.com/doc/refman/8.4/en/replication-mode-change-online-enable-gtids.html)

| 단계 | 대상 | 파라미터 설정 | 동작 | 비고 |
| :--- | :--- | :--- | :--- | :--- |
| 1 | 모든 DB 인스턴스 | enforce_gtid_consistency = WARN | GTID적용시 문제가 되는 SQL에 warning 발생 확인. | 파라미터 그룹 변경 후 적용.<br>문제가 예상되는 SQL을 warning에서 확인하고 <br>APP에서 수정합니다.<br>더이상 warning이 발생하지 않을때까지 지속합니다. |
| 2 | 모든 DB 인스턴스 | enforce_gtid_consistency = ON | 문제가 되는 SQL에 에러 발생 | 파라미터 그룹 변경 후 적용.<br>더이상 GTID에서 문제가 되는 쿼리가 수행되지 못합니다. |
| 3 | 모든 DB 인스턴스 | gtid_mode = OFF_PERMISSIVE | Replica가 GTID를 처리할 수 있도록 준비 | 파라미터 그룹 변경 후 적용.<br>모든 Replica가 먼저 OFF_PERMISSIVE가 되어야만 문제가 발생하지 않습니다. |
| 4 | 모든 DB 인스턴스 | gtid_mode = ON_PERMISSIVE | Source가 GTID를 생성 | 파라미터 그룹 변경 후 적용. |
| 5 | 모든 DB 인스턴스 | - | 잔여 ANONYMOUS 트랜잭션 확인 | `SHOW STATUS LIKE 'ONGOING_ANONYMOUS_TRANSACTION_COUNT';`<br>모든 서버에서 결과 0이 최소 1번은 나와야 합니다. |
| 6 | 모든 DB 인스턴스 | gtid_mode = ON | 모든 트랜젝션은 GTID만 사용 | 파라미터 그룹 변경 후 적용. |

> [주의]
> * 각 단계에서 파라미터 그룹 변경 후에는 반드시 [파라미터 그룹 변경 사항 적용](parameter-group/#apply)을 수행해야 합니다.
> * gtid_mode와 enforce_gtid_consistency 파라미터 변경 시 DB 인스턴스 재시작이 필요할 수 있습니다.
> * GTID 적용해제는 적용의 역순으로 진행합니다.
