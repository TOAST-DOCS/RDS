## Database > RDS for MySQL > コンソール使用ガイド

## 開始する

RDS for MysQLを使用するには、先にDBインスタンスを作成する必要があります。DBインスタンスは次の方法で作成できます。

* **Console > Database > RDS for MySQL**の **DB Instance **タブで左上の **+ 作成** ボタンをクリックすると、下図のようにページの下に入力画面が現れます。

![rds_01_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_01_20210112_jp.png)

* **詳細設定** 画面に表示された必須項目をすべて入力した後、画面右上の **次へ** ボタンをクリックします。
    * DB Instance：DBインスタンス名を入力します。
    * 説明：DBインスタンスの説明を入力します。
    * DB Engine：作成するデータベースエンジンバージョンを選択します。
    * DB Port：データベースのポート番号を入力します。 
        * 10000～12000の間で設定できます。
    * DB User ID：データベース作成時に作成される管理者アカウントIDを入力します。
    * DB Password：データベース作成時に作成される管理者アカウントパスワードを入力します。
    * VPC Subnet：作成するDBインスタンスとprivate network通信をするCompute & Networkサービスのサブネットを選択します。
    * Floating IP：TOASTクラウド外部ネットワークと接続する場合、Floating IPを使用に設定します。
    * Flavor：DBインスタンスのタイプを選択します。
    * Storageタイプ：DBインスタンスボリュームのタイプを指定します。
        * HDDおよびSSDを選択できます。
    * Storage：DBインスタンスボリュームのサイズを入力します。 
        * 20GB～2,000GBのサイズで作成できます。
    * Availabillity Zone：DBインスタンスが作成される領域を選択します。
    * 高可用性：DBインスタンスを作成する時、Masterとは異なるAvailability ZoneにCandidate Masterを作成します。
    * Ping Interval：高可用性使用時、 Masterインスタンスの状態を確認する時間間隔を設定します。4回失敗すると障害と判断します。
        * 1～600秒の間で設定できます。
    * DBファイルの暗号化：ユーザーデータファイルおよびバックアップファイルを暗号化します。
    * 基本アラーム：DBインスタンスのイベントのうち、定義されているイベントに対するアラームを登録できます。
        * 基本アラーム使用時、受信グループを選択する必要があります。

> [参考]選択したComputeおよびNetworkのサービスのVPCサブネットがインターネットゲートウェイと接続されていない場合、Floating IPを使用できません。
> [参考]一度選択したVPCサブネットは変更できません。
> [参考] Candidate Masterインスタンスは、必ずMasterと異なるAvailability Zoneに作成され、リストに表示されません。
> [参考]インスタンスリストは、各インスタンスの作成順にソートされ、Candidate MasterはMasterの高可用性オプション使用時点で作成されるため、フェイルオーバー後、インスタンスの順序が変わる場合があります。
> [参考] DBファイル暗号化機能を使用すると、パフォーマンスが多少低下する場合があります。
> [参考]基本アラーム使用時、該当インスタンスに対するアラームが自動的に登録され、名前は"{インスタンス名}-default"に設定されます。登録されるアラームは変更および削除することができ、適用されるインスタンスも変更できます。

**バックアップ&アクセス制御** 画面でバックアップ情報を指定します。

![rds_02_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_02_20210112_jp.png)

* 自動バックアップおよびアクセス制御を設定した後、 **次へ** ボタンをクリックします。
* クエリー遅延待機時間：バックアップ遂行時にFLUSH TABLES WITH READ LOCK遅延待機時間を設定できます。 
  * 0～21600の間の値に設定できます。
* バックアップ保管期間：自動バックアップをするには、1日以上を選択します。
    **なし**を選択すると、自動バックアップが行われません。
* バックアップ開始時刻：自動バックアップはバックアップ開始時刻からDurationの間の任意の時点に始まります。
    * Durationはバックアップが始まる時刻を意味します。 
    * Duration内にバックアップが終了することを意味するわけではありません。
* ユーザーアクセス制御：DBインスタンスにアクセス可能なユーザーをCIDR形式で入力します。
    * ユーザーアクセス制御に登録されていないIPは接続できません。
    * アクセス制御を行う時、方向設定で`受信/送信`を許可するかどうかを選択します。

DB Configuration画面で設定値を変更できます。

![rds_03_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_03_20210112_jp.png)

* 設定値を変更した後、 **作成** ボタンをクリックします。
* 最後に **確認** ボタンをクリックすると、DBインスタンスが作成されます。
* 作成されるまで、数分から数十分かかります。

### DBインスタンス接続

* 作成されたDBインスタンスを選択すると、詳細設定を確認できます。 
* インスタンス[詳細設定]の[接続情報]で、接続可能なドメイン情報を確認できます。
* Floating IPを‘使用’に設定していないDBインスタンスは、外部からアクセスできません。


1. 外部から接続をテストするために右上の **変更** ボタンをクリックします。
2. Floating IP項目を **使用する**に修正します。
3. **確認** ボタンをクリックすると、修正事項が反映されます。

![rds_04_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_04_20210112_jp.png)

* 設定後、Floating IPが作成され、外部からアクセスできることを確認できます。

![rds_05_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_05_20210112_jp.png)

* 次はMySQL Workbenchの接続例です。

![rds_06_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_06_20210112_jp.png)

#### 制約事項

* ユーザーComputeサービスのインスタンスがdnsサーバーに接続できないネットワーク環境の場合、該当インスタンスはドメインを通してRDSインスタンスに接続できません。

## DBインスタンス

### 高可用性

* 別のAvailability ZoneにCandidate Masterを作成しておけば、Masterに障害が発生した時、フェイルオーバーを進行させることができます。
* 高可用性インスタンスを再起動する時、[フェイルオーバーを利用した再起動]オプションを選択し、MasterとCandidate Masterを交換できます。
* 高可用性を使用したインスタンスの場合、一部オプションを変更する時、接続情報は変わりませんが、MasterとCandidate Masterインスタンスは変わる場合があります。
* 障害が発生し、高可用性インスタンスにフェイルオーバーが実行された時、変更された新しいMasterインスタンスは、既存のMasterインスタンスのバックアップを継承しません。

> [参考]高可用性インスタンス使用時、 MySQLクエリーを使用して他のインスタンスまたは外部MySQLのMasterから強制的に複製するように設定すると、高可用性および一部機能が正常に動作しません。

#### 高可用性の一時停止および再開

* 一時的な作業によりMasterインスタンスに接続中断または大量の負荷が予想される状況で、一時的に高可用性機能を中止できます。
* 高可用性機能が一時中止されると障害を検知しません。したがってフェイルオーバーが行われません。
* 高可用性機能が一時中止された状態でインスタンスを変更したり、再起動すると、一時停止した高可用性機能を再開します。
* 高可用性機能が一時中止されても、データの複製は正常に行われますが、障害が検知されないため、長時間一時停止状態にすることは推奨しません。

#### 制約事項

* 高可用性インスタンスは、最初の1回のフェイルオーバーを保障します。障害が発生してフェイルオーバーした場合、Candidate Masterインスタンスが高可用性機能を使用しない一般Masterに変更されます。
* 変更された新しいMasterインスタンスは、既存Masterインスタンスの接続に使用されるドメインを継承します。
* また、高可用性オプションを新たに指定して使用できます。
* フェイルオーバーを行った既存のMasterインスタンスは、接続情報が変更され、’中止’状態に変わります。
* フェイルオーバーを行った既存のMasterインスタンスは、インスタンス再起動機能を利用して再起動を試行できますが、障害によるデータ損失などの理由で再起動できなかったり、正常に作動しない場合があります。
* Read Only Slaveインスタンスには高可用性機能を提供しません。
* 高可用性機能を使用するインスタンスを再起動したり、オプションを変更する間は、該当インスタンスのRead Only Slave操作ができなくなります。
* 高可用性機能はドメインを基盤にしています。そのため、ユーザーのComputeサービスのインスタンスがDNSサーバーに接続できないネットワーク環境の場合、該当インスタンスはドメインを通してRDSインスタンスに接続することができず、障害措置発生時、正常に接続できません。


### インスタンスタイプ

* TOAST ComputeおよびNetworkのサービスで提供中のインスタンスタイプから選んでDBインスタンスを作成できます。

### バックアップ

* RDSでは、すべてのバックアップを実行した後、作成したバックアップを独自のObject Storageにアップロードして保管します。
* 自動バックアップに限り、原本インスタンスのデータボリュームサイズ分のバックアップ容量を無料で提供します。
* 別途料金を希望しない場合は、バックアップ周期を調整する必要があります。
* バックアップの実行中は、性能が低下することがあります。
* サービスに影響を与えないようにするには、サービスの負荷が小さい時間にバックアップを行ってください。
* TOAST RDSは時点復元をサポートします。
    * バイナリログ(binary log)サイズと保管周期が短すぎる場合、希望する時点に復元するのが困難な場合があります。
* 復元中のDBインスタンスはバックアップできません。

#### 自動バックアップ

* DBインスタンスのバックアップ周期を1日以上に設定すると、自動バックアップが有効になります。
    * バックアップ周期を1日以上から、なしに変更すると、即時にすべての自動バックアップはサーバーから削除されます。
    * 削除されたバックアップは復元できません。
* 設定されたバックアップ周期分、バックアップファイルを維持します。
* 自動バックアップは、バックアップ開始時刻からDurationの間の任意の時点に始まります。
* Durationはバックアップが始まる時刻を意味します。 Duration内にバックアップが完了するということではありません。
    * Duration内にバックアップを完了できなくてもバックアップは終了しません。
* 自動バックアップは、原本インスタンスを全て削除する場合、一緒に削除されます。

> [参考] MySQL 5.7以上ではバックアップ中にインデックス作成や、再度ビルドを行うとバックアップに失敗します。

#### 手動バックアップ

* 自動バックアップ以外に、いつでも手動でバックアップできます。
* 手動バックアップは、明示的に削除しない限り削除されません。

### 復元

* 保管されたバックアップを利用して、希望する時点にDBインスタンスを復元できます。
* 復元時、原本DBインスタンスを変更せず、新しいDBインスタンスを作成します。
* バックアップの保存位置がObject Storageにある場合、さらに時間がかかります。
* バックアップ中のDBインスタンスを利用して復元できません。
> [参考]復元の進行中、Binary Logファイルのサイズ分、Object Storage使用量が発生することがあります。
> [参考]バイナリログファイルがない時は、時点復元ができません。

### コピー

* 読み取り性能高めるには、MySQLがサポートするRead Only Slaveを作成します。
* Read Only Slaveを作成するには、原本DBインスタンスを選択した後、 **追加機能 > コピー作成**を選択します。

![rds_07_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_07_20210112_jp.png)

* コピー作成のための詳細設定を入力し、 **コピー** ボタンをクリックすると、コピーが作成されます。
* コピー元DBインスタンスと同じタイプまたはさらにスペックの高いタイプでの作成を推奨します。スペックの低いタイプで作成した場合、コピー作成処理に遅延が発生することがあります。
* コピー作成時、コピー元のDBインスタンスのI/O性能が通常より低下することがあります。
* コピー元のDBインスタンスのサイズに比例して、コピー作成時間が増加することがあります。
> [参考]コピーの進行中、バイナリログファイルのサイズ分、Object Storage使用量が発生することがあります。
> [参考]複製が完了すると、Masterインスタンスのアクセスルール(access rule)項目にRead Only Slaveのルールが追加されます。 

#### 制約事項

* 1つの原本インスタンスは、最大5個のコピーを作成することができます。
* コピーのコピーは作成できません。

### 昇格

* コピー関係を切り、Read Only SlaveからMasterに変更することを昇格と呼びます。
* 昇格したコピーは、原本DBインスタンスの修正事項を自動的に反映しません。
* 昇格したコピーは、独立したDBインスタンスとして動作するようになります。
* 昇格するコピーと原本DBインスタンスの間にコピー遅延がある場合、遅延がなくなるまで昇格されません。

### 容量の確保

*  DBインスタンスのリソースを削除し、ディスク容量を確保できます。

#### バイナリログ削除

![rds_08_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_08_20210112_jp.png)

* バイナリログファイルを削除してディスクスペースを確保します。

>[注意]選択した対象バイナリログファイルと、それ以前に作成されたバイナリログファイルがすべて削除されます。
>[注意]バイナリログファイルを削除した時、削除したバイナリログファイルによっては特定時点に復元できない場合もあります。
>[注意]バイナリログファイルを全て削除した時は、時点復元を使用できません。


### ストレージ拡張

![rds_09_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_09_20210112_jp.png)

* DBインスタンスのストレージサイズを拡張します。
* Read Only Slaveが存在する場合、Masterと同じストレージサイズに拡張されます。
* 対象DBインスタンスの再起動を伴います。

### DBファイルの暗号化

* ユーザーデータが保存されるデータベースファイルおよびバックアップファイルを暗号化します。

> [参考]リアルタイムに暗号化を行うため、DBインスタンスのパフォーマンスが多少低下する場合があります。

#### 制約事項

* DBファイルの暗号化機能を使用しないインスタンスから復元または複製をした時、DBファイルの暗号化機能を有効にできません。
* DBファイルの暗号化機能を使用するインスタンスから復元また複製をした時、DBファイルの暗号化機能を無効にできません。

## モニタリング

* RDSはDB運営および使用に必要なモニタリング項目を周期的に収集し、チャートで表示します。
* 特定DBインスタンスのモニタリング項目を見たい場合は、**DB Instance** リストから特定DBインスタンスを選択し、 **Monitoring** タブを選択します。

![rds_10_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_10_20210112_jp.png)

* 特定DBインスタンスのモニタリング項目を見たい場合は、**Monitoring** タブで希望するDBインスタンスを選択し、 **追加** ボタンをクリックします。
* チャート範囲、間隔、種類および項目を変更すると、変更事項が追加されたすべてのDBインスタンスに影響を与えます。

![rds_11_20210112](https://static.toastoven.net/prod_rds/21.01.12/rds_11_20210112_jp.png)

* チャートの範囲を簡単に調整できるボタンを使用できます。
* 1時間、6時間などのボタンを押すと、現在の時刻を基準に自動でfrom～toを計算してアップデートします。
<br/>
* チャート範囲よって選択できるチャート間隔が異なります。
    * 2時間以内：1分、10分
    * 12時間以内：10分、 1時間
    * 4日以内：1時間、 6時間
    * 2週以内：6時間、1日
    * それ以外：1日
* チャート種類は、最大値と平均値をサポートします。

> [参考] RDS DBインスタンス別モニタリングデータは、ユーザーDBインスタンスの'rds_maintenance'というデータベースに臨時で保存されて削除されます。したがって作成した後、何も動作していないインスタンスでも、いくつかのモニタリング項目が規則的に動くグラフ形式が現れることがあります。
> [参考] rds_maintenance databaseのデータを操作すると、正確ではないモニタリングデータが収集されることがあります。

### DBスキーマ& DB User管理

* DBスキーマとDB UserをWebコンソールで管理できます。

> [参考] DBスキーマとDB Userをクエリーで作成、修正、削除できません。
![db_schema_and_user_list_20210209_ko](https://static.toastoven.net/prod_rds/21.02.09/db_schema_and_user_list_20210209_ko.png)

* **変更**ボタンを押すと、DBスキーマとユーザーを変更できるようになります。

![db_schema_and_user_modify_20210209_ko](https://static.toastoven.net/prod_rds/21.02.09/db_schema_and_user_modify_20210209_ko.png)

* **追加**ボタンを押すと、DBスキーマとDB Userの変更事項が一度に適用されます。
* DBスキーマの名前変更はサポートしません。
* DB Userの権限は4個の権限で構成されます。
  * READ：データを照会できます。
  * CRUD：READ権限に加えてDMLクエリを実行できます。
  * DDL：CRUD権限に加えてDDLクエリを実行できます。
  * CUSTOM：既存ユーザーの権限です。 CUSTOM権限に変更することはできず、CUSTOM権限のユーザーは削除のみ可能です。

> [注意] Read Only Slaveを持っていたり、高可用性インスタンスの場合、既存DB Userで直接ユーザーを追加すると複製が中断される場合があります。これはMySQLのバグです。必ずWebコンソールからユーザーを追加してください。
* 下記のDB Userはポリシー上使用できません。
  * mysql.session
  * mysql.sys
  * sqlgw
  * admin
  * etladm
  * alertman
  * prom
  * rds_admin
  * rds_mha
  * rds_repl
