## Database > RDS for MySQL > バックアップおよび復元

## バックアップ 개요

障害状況に備えて、DBインスタンスのデータベースを復旧できるように事前に準備することができます。必要な時にWebコンソールでバックアップを実行したり、定期的にバックアップが実行されるように設定できます。バックアップが実行されている間は当該DBインスタンスのストレージのパフォーマンス低下が発生する可能性があります。サービスに影響を与えないように、サービスの負荷が少ない時間にバックアップすることを推奨します。백업으로 인한 성능 저하를 원치 않을 경우 고가용성 구성을 사용하거나, 이전 백업 이후 데이터의 증분만 백업하거나, 읽기 복제본에서 백업을 수행할 수도 있습니다.

> [参考]
> 高可用性DBインスタンスは予備マスターでバックアップが行われ、マスターのストレージパフォーマンス低下が発生しません。
> 단, 다음의 경우 고가용성 DB 인스턴스이더라도 마스터에서 백업이 수행될 수 있습니다.
> * 예비 마스터 장애로 인해 백업 수행이 불가능한 상태인 경우
> * 예비 마스터 재구축을 위해 예비 마스터가 아닌 다른 DB 인스턴스에서 수행한 백업이 필요한 상황에서 읽기 복제본이 없는 경우

RDS for MySQLでは、Percona XtraBackupを利用してデータベースをバックアップします。外部MySQLのバックアップで復元したりRDS for MySQLのバックアップで復元するにはRDS for MySQLで使用するPercona XtraBackupと同じバージョンを使用する必要があります。
DBエンジンバージョン別のPercona XtraBackupバージョンは次のとおりです。

| MySQLバージョン | XtraBackupバージョン |
|------------|-----------------|
| 5.7.15     | 2.4.28          |
| 5.7.19     | 2.4.28          |
| 5.7.26     | 2.4.28          |
| 5.7.33     | 2.4.28          |
| 5.7.37     | 2.4.28          |
| 8.0.18     | 8.0.32          |
| 8.0.23     | 8.0.32          |
| 8.0.28     | 8.0.32          |
| 8.0.32     | 8.0.32          |
| 8.0.33     | 8.0.33          |
| 8.0.34     | 8.0.34          |
| 8.0.35     | 8.0.35          |
| 8.0.36     | 8.0.35          |

* XtraBackupのインストールに関する詳しい説明はPercona Webサイトを参照します。
  * https://www.percona.com/doc/percona-xtrabackup/2.4/index.html
  * https://www.percona.com/doc/percona-xtrabackup/8.0/index.html

> [参考]
> 2023年8月17日XtraBackupユーティリティのバージョンがアップグレードされました。以前バックアップに使用されたXtraBackupバージョンはWebコンソールで確認できます。

## 백업 종류

백업은 수동 백업과 자동 백업으로 구분할 수 있습니다.

### 手動バックアップ

特定の時点のデータベースを永久に保存するには、Webコンソールから手動でバックアップを実行することができます。手動バックアップは自動バックアップと異なり、明示的にバックアップを削除しない限り、DBインスタンスが削除されるときと同じように削除されません。
수동 백업 생성 시에는 백업 이름을 지정해야 하며, 다음과 같은 제약 사항이 있습니다.
* バックアップ名はリージョンごとに固有の名前でなければなりません。
* バックアップ名は1～100文字の間の英字、数字、一部の記号（-、_、.）のみ使用でき、最初の文字は英字のみ使用できます。

![db-instance-backup-ja](https://static.toastoven.net/prod_rds/24.03.12/db-instance-backup-ja.png)
![backup-list-1-ja](https://static.toastoven.net/prod_rds/24.09.10/backup-list-1-ja.png)

**수동 전체 백업 생성하기**

❶ DB 인스턴스 목록에서 백업할 DB 인스턴스 선택 후 **백업**을 클릭하여 수동으로 전체 백업을 생성할 수 있습니다.
❷ 백업 목록에서 **전체 백업 생성**을 클릭하고 백업할 DB 인스턴스를 지정하여 수동으로 전체 백업을 생성할 수 있습니다.

**수동 증분 백업 생성하기**

❸ 백업 목록에서 기준 백업을 선택 후 **증분 백업 생성**을 클릭하여 증분 백업을 생성할 수 있습니다. 일부 백업은 기준 백업으로 선택할 수 없습니다. 기준 백업에 대한 자세한 설명은 [기준 백업](#기준-백업)을 참고합니다.

### 自動バックアップ
手動でバックアップを実行する場合以外にも、復元作業のために必要な場合、または自動バックアップスケジュールの設定によって自動バックアップが実行されることがあります。
자동 백업 시에 적용되는 설정 항목은 [자동 백업 설정](#자동-백업-설정)을 참고합니다.

## 백업 방식

전체 백업과 증분 백업 방식이 제공됩니다.

### 전체 백업

DB 인스턴스의 모든 데이터를 백업합니다.

### 증분 백업

기준 백업이 수행된 이후의 데이터 변경분 만을 증분 방식으로 백업합니다. 변경이 잘 일어나지 않는 데이터가 대부분인 경우 추천됩니다.
증분 백업은 항상 기준 백업을 수행했던 DB 인스턴스에서 수행됩니다.
증분 백업으로 복원 시 최초 생성된 전체 백업 복원을 진행하고, 선택한 증분 백업에 도달할 때까지의 모든 증분이 순차적으로 반영됩니다.

> [주의]
> 증분 백업으로 복원 시에는 전체 백업으로 복원할 때보다 복원에 더 많은 시간이 소요될 수 있으며 이는 복원에 필요한 증분 백업들의 용량의 합에 비례합니다.

#### 기준 백업

증분 백업에는 데이터 변경사항의 기준이 될 백업이 필요합니다. 증분 백업도 새로운 증분 백업의 기준 백업이 될 수 있습니다.

증분 백업의 기준이 되는 백업에는 다음 제약사항이 존재합니다. 수동 및 자동으로 증분 백업 시에 공통으로 적용됩니다.
* 에러 상태의 백업은 기준 백업이 될 수 없습니다.
* 마지막 장애 조치 이전에 생성된 백업은 기준 백업이 될 수 없습니다.
* 마지막 DB 엔진 버전 업그레이드 이전에 생성된 백업은 기준 백업이 될 수 없습니다.
* 이미 해당 백업을 기준으로 한 증분 백업이 존재하는 경우 기준 백업이 될 수 없습니다. 단, 이전 증분이 실패한 경우에는 동일한 백업을 기준으로 증분이 가능합니다.
* 해당 백업을 수행했던 DB 인스턴스가 삭제되었거나 장애로 인해 백업을 수행할 수 없는 상태라면 기준 백업이 될 수 없습니다.
* 2024년 9월 정기 배포 이전에 생성된 백업은 기준 백업이 될 수 없습니다.

[자동 백업 스케줄 전략](#자동-백업-설정)에 따라 증분 백업이 스케줄 되는 경우 위 제약사항과 함께 다음 추가 제약사항을 만족하는 기준 백업이 자동으로 선택됩니다. 제약사항을 만족하는 기준 백업이 없는 경우 자동 백업 스케줄 전략과 관계 없이 전체 백업을 수행합니다.
* 복제 중단 상태인 예비 마스터, 읽기 복제본에서 수행된 백업은 기준 백업이 될 수 없습니다.
* 테이블 잠금을 사용하지 않은 상태에서 수행된 백업은 기준 백업이 될 수 없습니다.
* 해당 백업 생성 이후에 새로운 전체 백업이 생성된 경우 기준 백업이 될 수 없습니다.

## 백업 설정

DB 인스턴스 생성 및 수정 시 백업에 적용될 설정 항목들을 지정할 수 있습니다.

![db-instance-backup-ja](https://static.toastoven.net/prod_rds/24.09.10/db-instance-backup-ja.png)

### 공통 설정

バックアップ時に適用される設定項目は以下の通りで、自動バックアップと手動バックアップの両方に適用されます。

**テーブルロックの使用**

* `FLUSH TABLES WITH READ LOCK`構文を実行するかどうかを設定します。
* テーブルロックを使用すると、バックアップデータの一貫性を保証するために、バックアップ時に定期的に`FLUSH TABLES WITH READ LOCK`構文を実行します。FLUSH TABLES WITH READ LOCK`構文の実行に失敗した場合、バックアップに失敗します。
* バックアップが実行される間、DMLクエリの負荷が多い場合、テーブルロックを無効にすることができます。テーブルロックを使用しない場合、`FLUSH TABLES WITH READ LOCK`構文を実行しないため、DML負荷が多くてもバックアップが失敗しません。しかし、テーブルロックを使用しないバックアップは、バックアップデータの一貫性が保証されない可能性があり、これにより、テーブルロックを使用せずに作成されたバックアップおよびテーブルロックを使用しないように設定されたDBインスタンスに対する復元および複製過程を含む一部の作業をサポートしません。

**クエリ遅延待機時間(秒)**

* テーブルロックを使用する場合、`FLUSH TABLES WITH READ LOCK`構文の待機時間を設定します。クエリ遅延待機時間だけ`FLUSH TABLES WITH READ LOCK`構文が待機します。0～21,600秒まで設定できます。長く設定するほど、DMLクエリの負荷によるバックアップ失敗の可能性を減らすことができますが、全体のバックアップ時間が長くなる可能性があります。


### 自動バックアップ 설정

自動バックアップでサポートする設定項目は下記の通りです。

**自動バックアップを許可**

* 自動バックアップを許可しない場合、すべての自動バックアップの実行がブロックされ、必要に応じてバックアップが実行される可能性がある復元、複製過程を含む一部の作業をサポートしません。 また、以下の自動バックアップ関連項目については設定ができません。

**自動バックアップの保管期間**

* 自動バックアップをバックアップストレージに保存する期間を設定します。最大730日まで保管することができ、自動バックアップの保管期間が変更されると、保管期間が過ぎた自動バックアップファイルはすぐに削除されます。

  > [주의]
  > 증분 방식으로 생성된 백업은 자동 백업 보관 기간이 지나지 않았더라도 기준 백업이 삭제될 때 함께 삭제됩니다.

**自動バックアップ複製リージョン**

* 自動バックアップファイルを他のリージョンのバックアップストレージに複製するように設定します。自動バックアップ複製リージョンは、災害復旧(disaster recovery)のための機能で、ソースリージョンの自動バックアップファイルをターゲットリージョンに同じように複製して管理します。複製はバックグラウンドで一定周期ごとに行われます。自動バックアップ複製リージョンを設定すると、リージョン間の複製トラフィック費用が請求され、対象リージョンにバックアップストレージ使用量に対する費用が追加で請求されます。

**自動バックアップの再試行回数**

* DMLクエリの負荷または様々な理由で自動バックアップが失敗した場合、再試行するように設定できます。最大10回まで再試行できます。再試行回数が残っていても、自動バックアップの実行時間設定によって再試行しない場合があります。

**自動バックアップスケジュールの使用**

* 自動バックアップスケジュールを使用すると、設定した自動バックアップ実行時間に自動的にバックアップが実行されます。

**자동 백업 스케줄 전략**

* 자동 백업을 수행할 전략을 지정할 수 있습니다.
  * 매일 전체 백업 : 매일 전체 데이터를 백업합니다.
  * 매일 전체 및 증분 백업 : 매일 전체 데이터를 1회 백업하고, 수 회 증분을 백업합니다.
  * 주간 전체 백업 및 일일 증분 백업 : 특정 요일에 전체 데이터를 1회 백업하고, 나머지 요일에는 증분을 1회 백업합니다.

**전체 데이터 백업 요일**

* 주간 전체 백업 및 일일 증분 백업 전략 사용 시에만 지정 가능합니다. 최소 1개 ~ 최대 6개의 요일을 선택해야 하며, 선택한 요일에는 전체 백업이 진행되고 선택하지 않은 요일에는 증분 백업이 진행됩니다.

**バックアップ実行時間**

* バックアップが自動的に実行される時間を設定できます。バックアップ開始時刻とバックアップウィンドウ、バックアップ再試行有効期限で構成されます。バックアップ実行時間は重複しないように複数回設定できます。バックアップ開始時刻を基準に、バックアップウィンドウ内のある時点でバックアップを実行します。バックアップウィンドウはバックアップの総実行時間とは関係ありません。バックアップにかかる時間はデータベースのサイズに比例し、サービス負荷によって異なります。バックアップが失敗した場合、バックアップ再試行期限を超えなければ、バックアップ再試行回数に基づいてバックアップを再試行します。

> [注意]
> 前のバックアップが終了していないなど、バックアップを実行できない状況ではバックアップが実行されない場合があります。
> 스케줄 상 증분 백업을 수행할 차례이더라도 증분이 가능한 기준 백업이 존재하지 않는 경우 전체 백업이 수행될 수 있습니다.
> 증분 가능한 기준 백업에 대한 자세한 설명은 [기준 백업](#기준-백업) 항목을 참고합니다.

### バックアップストレージおよび課金

すべてのバックアップファイルは、内部バックアップストレージにアップロードして保存します。手動バックアップの場合、別途削除するまで永続的に保存され、バックアップ容量に応じてバックアップストレージの料金が発生します。自動バックアップの場合、設定した保管期間だけ保存され、自動バックアップファイルの全体サイズのうち、DBインスタンスのストレージサイズを超過した容量に対して課金されます。バックアップファイルが保存されている内部バックアップストレージに直接アクセスすることはできず、バックアップファイルが必要な場合は、NHN Cloudのオブジェクトストレージにバックアップファイルをエクスポートできます。

### バックアップのエクスポート

#### 백업을 수행하면서 파일 내보내기

백업을 수행함과 동시에 백업 파일을 사용자 오브젝트 스토리지로 내보낼 수 있습니다. 증분 백업에 대해서는 지원되지 않습니다. 증분 백업에 대해서는 지원되지 않습니다.

![db-instance-list-export-obs-ja](https://static.toastoven.net/prod_rds/24.03.12/db-instance-list-export-obs-ja.png)

![db-instance-list-export-obs-modal-ja](https://static.toastoven.net/prod_rds/24.03.12/db-instance-list-export-obs-modal-ja.png)

❶バックアップするDBインスタンスを選択した後、ドロップダウンメニューから**オブジェクトストレージにバックアップをエクスポート**をクリックすると、設定ポップアップ画面が表示されます。
❷バックアップが保存されるオブジェクトストレージのテナントIDを入力します。テナントIDはAPIエンドポイント設定で確認できます。
❸バックアップが保存されるオブジェクトストレージのNHN CloudメンバーまたはIAMメンバーを入力します。
❹バックアップが保存されるオブジェクトストレージのAPIパスワードを入力します。
❺バックアップが保存されるオブジェクトストレージのコンテナを入力します。
❻コンテナに保存されるバックアップのパスを入力します。フォルダ名は最大255バイトで、全体のパスは最大1024バイトです。特定の形(. または ..)は使用できず、特殊文字(' " < > ;)とスペースは入力できません。

#### バックアップファイルのエクスポート

内部バックアップストレージに保存されたバックアップファイルをNHN Cloudのユーザーオブジェクトストレージにエクスポートできます。증분 백업에 대해서는 지원되지 않습니다.

![db-instance-detail-backup-export-ja](https://static.toastoven.net/prod_rds/24.03.12/db-instance-detail-backup-export-ja.png)

❶バックアップを実行した原本DBインスタンスの詳細タブでエクスポートするバックアップファイルを選択した後、**オブジェクトストレージにバックアップをエクスポート**をクリックすると、バックアップをエクスポートするためのポップアップ画面が表示されます。

![backup-export-ja](https://static.toastoven.net/prod_rds/24.03.12/backup-export-ja.png)

❷または**バックアップ**タブでエクスポートするバックアップファイルを選択した後、**オブジェクトストレージにバックアップをエクスポート**をクリックします。

> [参考]
> 手動バックアップの場合、バックアップを実行した元DBインスタンスが削除されると、バックアップをエクスポートできません。

## 復元

バックアップを利用して希望の時点にデータを復元できます。復元時には常に新しいDBインスタンスが作成され、既存のDBインスタンスに復元することはできません。バックアップを実行した元のDBインスタンスと同じDBエンジンのバージョンにのみ復元できます。バックアップが作成された時点に復元するスナップショット復元、希望する特定の時点に復元する時点復元をサポートします。RDS for MySQLで作成したバックアップだけでなく、外部MySQLのバックアップにも復元できます。

> [注意]
> 復元するDBインスタンスのデータストレージサイズがバックアップを実行した元のDBインスタンスのストレージサイズより小さい場合や、元のDBインスタンスのパラメータグループと異なるパラメータグループを使用する場合、復元に失敗することがあります。

### スナップショット復元

バックアップファイルだけで復元を行うため、バックアップを実行した原本DBインスタンスが必要ありません。 Webコンソールでスナップショットを復元するには

![db-instance-snapshot-restoration-ja](https://static.toastoven.net/prod_rds/24.03.12/db-instance-snapshot-restoration-ja.png)

❶ DBインスタンスの詳細タブで復元するバックアップファイルを選択した後、**スナップショット復元**をクリックすると、DBインスタンスの復元画面に移動します。

または

![snapshot-restoration-ja](https://static.toastoven.net/prod_rds/24.03.12/snapshot-restoration-ja.png)

❶バックアップタブで復元するバックアップファイルを選択した後、**スナップショット復元**をクリックします。

### 時点復元

時点復元を利用して、希望する特定の時点またはバイナリログ(binary log)の特定の位置に復元できます。時点復元をするためには、バックアップファイルとバックアップを実行した時点から復元を希望する時点までのバイナリログ(binary log)が必要です。バイナリログ(binary log)は、バックアップが行われる元DBインスタンスのストレージに保存されます。バイナリログ(binary log)の保管期間が短い場合、ストレージ容量をより多く使うことがありますが、希望する時点への復元が難しい場合があります。下記の場合、時点復元に必要なバイナリログ(binary log)がないため、希望の時点に復元できない場合があります。

* 容量確保のために元DBインスタンスのバイナリログ(binary log)を削除した場合。
* バイナリログ(binary log)保管期間に基づいてMySQLによって自動的にバイナリログ(binary log)が削除された場合
* 高可用性DBインスタンスのフェイルオーバーによりバイナリログ(binary log)が削除された場合。
* その他様々な理由でバイナリログ(binary log)が破損したり、削除されている場合。

Webコンソールで時点復元を行うには

![point-in-time-restoration-list-ja](https://static.toastoven.net/prod_rds/24.03.12/point-in-time-restoration-list-ja.png)

❶時点復元するDBインスタンスを選択した後、**+時点復元**をクリックすると、時点復元を設定できるページに移動します。

#### Timestampを利用した復元

Timestampを使用した復元の場合は、選択した時点と最も近いバックアップファイルを基準に復元を行い、希望する時点までのバイナリログ(binary log)を適用します。

![point-in-time-restoration-01-ja](https://static.toastoven.net/prod_rds/24.03.12/point-in-time-restoration-01-ja.png)

❶復元方法を選択します。

![point-in-time-restoration-02-ja](https://static.toastoven.net/prod_rds/24.03.12/point-in-time-restoration-02-ja.png)

❷復元時刻を選択します。直近の時点に復元するか、希望する特定の時点を直接入力できます。

![point-in-time-restoration-03-ja](https://static.toastoven.net/prod_rds/24.03.12/point-in-time-restoration-03-ja.png)

❸ **復元される最後のクエリを確認**をクリックすると、最後に復元されるクエリを確認できるポップアップ画面が表示されます。

#### バイナリログ(binary log)を利用した復元

バイナリログ(binary log)を活用した復元過程では、選択したバックアップファイルで先に復元を行った後、希望する位置までのバイナリログ(binary log)を適用します。

![point-in-time-restoration-04-ja](https://static.toastoven.net/prod_rds/24.03.12/point-in-time-restoration-04-ja.png)

❹バイナリログ(binary log)で復元するためには、まず、バックアップファイルを選択する必要があります。
❺バイナリログ(binary log)ファイルを選択します。
❻バイナリログ(binary log)の特定位置を入力します。

### 外部MySQLバックアップを利用した復元

外部MySQLバックアップファイルを利用してDBインスタンスを作成できます。外部MySQLバックアップファイルを作成する時、[バックアップ](backup-and-restore/#_1)項目を参照してRDS for MySQLで使用するPercona XtraBackupと同じバージョンを使用する必要があります。

> [注意]
> innodb_data_file_pathの設定値がibdata1:12M:autoextendでない場合、RDS for MySQLのDBインスタンスに復元できません。

(1) MySQLがインストールされたサーバーで下記のコマンドを利用してバックアップを実行します。

**XtraBackup 2.4.xx例**

```
innobackupex --defaults-file={my.cnfパス} --user {ユーザー} --password '{パスワード}' --socket {MySQLソケットファイルのパス} --compress --compress-threads=1 --stream=xbstream {バックアップファイルが作成されるディレクトリ} 2>>{バックアップログファイルのパス} > {バックアップファイルのパス}
```

**XtraBackup 8.0.xx例**

```
xtrabackup --defaults-file={my.cnfパス} --user={ユーザー} --password='{パスワード}' --socket={MySQLソケットファイルのパス} --compress --compress-threads=1 --stream=xbstream --backup {バックアップファイルが作成されるディレクトリ} 2>>{バックアップログファイルのパス} > {バックアップファイルのパス}
```

(2)バックアップログファイルの最後の行に`completed OK!があるか確認します。`completed OK!`がない場合は、バックアップが正常に終了していないため、ログファイルにあるエラーメッセージを参照してバックアップを再度行います。

(3)完了したバックアップファイルをオブジェクトストレージにアップロードします。

* 一度にアップロードできる最大ファイルサイズは5GBです。
* バックアップファイルのサイズが5GBより大きい場合、splitのようなユーティリティを利用してバックアップファイルを5GB以下に分割した後、マルチパートでアップロードする必要があります。
* 詳細については、 [マルチパートアップロード](/Storage/Object%20Storage/ko/api-guide/#_44)を参照してください。

(4)復元するプロジェクトのWebコンソールに接続した後、DBインスタンスタブで**オブジェクトストレージにあるバックアップで復元**ボタンをクリックします。

> [注意]
> 現在5.7.33バージョンでは、オブジェクトストレージのバックアップファイルを利用したDBインスタンスの復元は制限されます。
> 推奨するXtraBackup以外のバージョンを使用すると、正常に動作しない場合があります。
> オブジェクトストレージのバックアップファイルと復元しようとするMySQLのバージョンは同じでなければなりません。

### RDS for MySQLのバックアップを利用した復元

RDS for MySQLのバックアップファイルを利用して直接MySQLのデータベースを復元することができます。전체 백업에 대해서만 복원이 가능하며, 증분 백업 반영은 지원되지 않습니다. RDS for MySQLのバックアップファイルを復元する時、[バックアップ](backup-and-restore/#_1)項目を参照してRDS for MySQLで使用するPercona XtraBackupと同じバージョンを使用する必要があります。

(1) [バックアップのエクスポート](backup-and-restore/#_5)の項目を参照して、RDS for MySQLのバックアップをオブジェクトストレージにエクスポートします。

(2)オブジェクトストレージのバックアップを復元したいサーバーにダウンロードします。

(3) MySQLサービスを停止します。

(4) MySQLデータ保存パスのすべてのファイルを削除します。

```
rm -rf {MySQLデータ保存パス}/*
```

(5)ダウンロードしたバックアップファイルを解凍して復元します。

**XtraBackup 2.4.xxの例**

```
cat {バックアップファイル保存パス} | xbstream -x -C {MySQLデータ保存パス}
innobackupex --decompress {MySQLデータ保存パス}
innobackupex --defaults-file={my.cnfパス} --apply-log {MySQLデータ保存パス}
```

**XtraBackup 8.0.xxの例**

```
cat {バックアップファイルの保存パス} | xbstream -x -C {MySQLデータ保存パス}
xtrabackup --decompress --target-dir={MySQLデータの保存パス}
xtrabackup --prepare --target-dir={MySQLデータ保存パス}
xtrabackup --defaults-file={my.cnfパス} --copy-back --target-dir={MySQLデータ保存パス}
```

(6)解凍後、不要なファイルを削除します。

```
find {MySQLデータ保存パス} -name "*.qp" -print0 | xargs -0 rm
```

(7) MySQLサービスを起動します。
